<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üç∫ Jule√∏lsmaking</title>
  <style>
    :root{
      --bg: #0e0f12;
      --muted: #9aa3b2;
      --text: #eef2ff;
      --border: rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    body.light{
      --bg:#f3f4f6;
      --muted:#6b7280;
      --text:#0b1020;
      --border: rgba(15,23,42,.10);
      --shadow: 0 12px 30px rgba(15,23,42,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1000px 700px at 20% -10%, rgba(124,58,237,.25), transparent 60%),
                  radial-gradient(900px 700px at 120% 0%, rgba(34,197,94,.18), transparent 60%),
                  radial-gradient(900px 700px at 50% 120%, rgba(245,158,11,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 18px 14px 60px; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap: wrap; margin-bottom: 12px;
    }

    .title{ display:flex; align-items:flex-start; gap:12px; }
    .logo{
      width:48px;height:48px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.95));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-size: 22px; flex: 0 0 auto;
    }
    h1{ margin:0; font-size: 20px; line-height: 1.1; letter-spacing: .2px; }
    .sub{ margin-top:4px; color: var(--muted); font-size: 13px; }

    .toolbar{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content:flex-end; }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-size: 14px;
      line-height: 1;
      box-shadow: 0 8px 20px rgba(0,0,0,.20);
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(124,58,237,.55));
      border-color: rgba(124,58,237,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(239,68,68,.55));
      border-color: rgba(239,68,68,.35);
    }
    .btn.ghost{ background: transparent; box-shadow: none; }

    .grid{ display:grid; grid-template-columns: 360px 1fr; gap: 12px; align-items:start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    body.light .card{ background: rgba(255,255,255,.75); }

    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.3px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .card .bd{ padding: 14px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .field{ display:grid; gap:6px; width:100%; margin-bottom: 10px; }
    label{ font-size: 12px; color: var(--muted); }

    input[type="text"], input[type="number"]{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size: 15px;
    }
    body.light input{ background: rgba(15,23,42,.04); }

    .muted{ color: var(--muted); font-size: 13px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      font-size: 13px;
      color: var(--text);
    }

    .statRow{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 420px){ .statRow{ grid-template-columns: 1fr; } }
    .stat{
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
    }
    .stat .k{ color: var(--muted); font-size: 12px; }
    .stat .v{ font-size: 20px; margin-top:2px; font-weight: 800; letter-spacing: .2px; }

    .divider{ height: 1px; background: var(--border); margin: 12px 0; }

    .list{ display:grid; gap: 10px; }

    .beer{ border-top: 1px solid var(--border); }
    .beer:first-child{ border-top: 0; }

    .beerHead{
      padding: 12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .beerTitle{
      display:flex; gap:10px; align-items:center;
      min-width: 240px; flex: 1 1 auto;
    }
    .num{
      width: 36px; height: 36px;
      border-radius: 12px;
      background: rgba(124,58,237,.18);
      border: 1px solid rgba(124,58,237,.28);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--text);
      flex: 0 0 auto;
    }
    .name{ display:flex; flex-direction:column; gap:2px; }
    .name strong{ font-size: 15px; }
    .name span{ color: var(--muted); font-size: 12px; }

    .beerActions{ display:flex; gap:8px; align-items:center; flex: 0 0 auto; }

    .beerBody{ padding: 0 14px 14px; display:none; }
    .beer.open .beerBody{ display:block; }

    .scoreGrid{ display:grid; grid-template-columns: 1.2fr 1fr; gap: 12px; align-items:start; }
    @media (max-width: 760px){ .scoreGrid{ grid-template-columns: 1fr; } }

    .criteria{ display:grid; gap: 10px; padding-top: 10px; }

    .crit{
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
    }
    .critTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom: 10px;
    }
    .critTop strong{ font-size: 14px; }
    .critTop .val{ font-weight: 900; font-size: 16px; }

    .diceRow{ display:flex; gap:6px; flex-wrap:wrap; }
    .die{
      min-width: 42px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
      user-select:none;
    }
    .die.active{
      background: rgba(124,58,237,.22);
      border-color: rgba(124,58,237,.40);
    }

    .rankList{ display:grid; gap:8px; }
    .rankItem{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
    }
    .rankLeft{ display:flex; gap:10px; align-items:center; min-width: 0; }
    .badge{
      width: 30px; height: 30px;
      border-radius: 12px;
      display:grid; place-items:center;
      font-weight: 900;
      background: rgba(245,158,11,.16);
      border: 1px solid rgba(245,158,11,.35);
      flex: 0 0 auto;
    }
    .rankText{ display:flex; flex-direction:column; min-width:0; }
    .rankText strong{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rankText span{ color: var(--muted); font-size: 12px; }

    .mono{ font-family: var(--mono); }
    .footerNote{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.4; }
    .smallBtn{ padding: 8px 10px; border-radius: 12px; font-size: 13px; }

    /* Tabs inside setup card */
    .setupTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .setupTab{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      color: var(--text);
      user-select:none;
    }
    .setupTab.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }
    .setupPane{ display:none; }
    .setupPane.active{ display:block; }

    .historyRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
    }
    .historyRow strong{ font-size: 14px; }
    .historyRow span{ color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo">üéÑ</div>
        <div>
          <h1>Jule√∏lsmaking</h1>
          <div class="sub">Terningkast 1‚Äì6 ‚Ä¢ autosave</div>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn ghost" id="themeBtn" title="Bytt tema">üåì Tema</button>
        <button class="btn danger" id="resetBtn" title="Nullstill alt">üß® Nullstill</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card" id="setupCard">
        <div class="hd">
          <h2>Oppsett</h2>
          <span class="pill" id="savePill">Lagrer ‚úÖ</span>
        </div>
        <div class="bd">
          <div class="setupTabs" role="tablist" aria-label="Oppsett faner">
            <button class="setupTab active" data-tab="main" type="button">Oppsett</button>
            <button class="setupTab" data-tab="history" type="button">Historikk</button>
          </div>

          <!-- Pane: main -->
          <div class="setupPane active" data-pane="main">
            <div class="field">
              <label>Antall √∏l</label>
              <div class="row">
                <input id="beerCount" type="number" min="1" max="60" style="max-width:140px" />
                <button class="btn primary smallBtn" id="rebuildBtn" type="button">Lag/oppdater</button>
              </div>
              <div class="muted">Standard er 24, men du kan justere.</div>
            </div>

            <div class="field">
              <label>Navn</label>
              <input id="playerNameInput" type="text" placeholder="F.eks. Andreas" />
              <div class="muted">Brukes kun som visning.</div>
            </div>

            <div class="divider"></div>

            <div class="statRow">
              <div class="stat">
                <div class="k">√òl med score</div>
                <div class="v" id="statScored">-</div>
              </div>
              <div class="stat">
                <div class="k">Total snitt</div>
                <div class="v" id="statAvg">-</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="field">
              <label>Toppliste ‚Äì √∏l</label>
              <div class="rankList" id="beerRankTop"></div>
            </div>

            <div class="field">
              <label>Fysj-liste ‚Äì √∏l</label>
              <div class="rankList" id="beerRankFysj"></div>
            </div>

            <div class="footerNote">
              Tips: Trykk p√• et √∏l for √• √•pne detaljene. Alt lagres lokalt p√• enheten din.
            </div>
          </div>

          <!-- Pane: history -->
          <div class="setupPane" data-pane="history">
            <div class="muted" style="margin-bottom:10px;">
              Hvem som har hostet jule√∏lsmakingen tidligere:
            </div>

            <div class="historyRow">
              <strong>2025</strong>
              <span>Hans M.</span>
            </div>

            <div style="height:8px"></div>

            <div class="historyRow">
              <strong>2024</strong>
              <span>Helge</span>
            </div>

            <div style="height:8px"></div>

            <div class="historyRow">
              <strong>2023</strong>
              <span>Helga</span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="hd">
          <h2>√òlliste</h2>
          <span class="pill mono" id="metaPill">-</span>
        </div>
        <div class="list" id="beerList"></div>
      </section>
    </div>
  </div>

  <script>
    // ----------------------------
    // State
    // ----------------------------
    const KEY = "juleol_single_v4";

    const CRITERIA = [
      { id: "aroma", label: "Aroma" },
      { id: "taste", label: "Smak" },
      { id: "finish", label: "Ettersmak" }
    ];

    const defaultState = () => ({
      version: 4,
      theme: "dark",
      settings: {
        beerCount: 24,
        playerName: "Deg"
      },
      beers: Array.from({ length: 24 }, (_, i) => ({
        id: cryptoRandomId(),
        num: i + 1,
        name: "",
        notes: "",
        ratings: {} // { aroma, taste, finish }
      }))
    });

    function cryptoRandomId(){
      return "b_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function clampInt(v, min, max){
      v = Number(v);
      if(!Number.isFinite(v)) v = min;
      v = Math.round(v);
      return Math.min(max, Math.max(min, v));
    }

    function ensureBeerCount(st, count){
      count = clampInt(count, 1, 60);
      const beers = st.beers.slice(0, count);
      while(beers.length < count){
        beers.push({
          id: cryptoRandomId(),
          num: beers.length + 1,
          name: "",
          notes: "",
          ratings: {}
        });
      }
      beers.forEach((b, i) => b.num = i + 1);
      st.beers = beers;
      st.settings.beerCount = count;
      return st;
    }

    function normalize(st){
      if(!st || typeof st !== "object") return defaultState();

      const base = defaultState();
      let out = {
        ...base,
        ...st,
        settings: { ...base.settings, ...(st.settings || {}) },
      };

      if(!Array.isArray(st.beers)) out.beers = base.beers;
      else out.beers = st.beers.map((b, idx) => ({
        id: b.id || cryptoRandomId(),
        num: Number(b.num) || (idx+1),
        name: (b.name ?? ""),
        notes: (b.notes ?? ""),
        ratings: (b.ratings && typeof b.ratings === "object") ? b.ratings : {}
      }));

      out.settings.beerCount = clampInt(out.settings.beerCount, 1, 60);
      out.settings.playerName = String(out.settings.playerName ?? "Deg").trim() || "Deg";

      out = ensureBeerCount(out, out.settings.beerCount);
      return out;
    }

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        return normalize(JSON.parse(raw));
      }catch{
        return defaultState();
      }
    }

    function setSavePill(saved){
      const el = document.getElementById("savePill");
      el.textContent = saved ? "Lagrer‚Ä¶ üíæ" : "Lagrer ‚úÖ";
      el.style.borderColor = saved ? "rgba(245,158,11,.35)" : "var(--border)";
      el.style.background = saved ? "rgba(245,158,11,.14)" : "rgba(255,255,255,.06)";
    }

    function save(){
      localStorage.setItem(KEY, JSON.stringify(state));
      setSavePill(true);
      clearTimeout(save._t);
      save._t = setTimeout(() => setSavePill(false), 700);
    }

    // for typing (prevents jumping)
    function saveDebounced(){
      clearTimeout(saveDebounced._t);
      saveDebounced._t = setTimeout(() => save(), 350);
    }

    // ----------------------------
    // Calculations (single player)
    // ----------------------------
    function beerTotal(beer){
      const r = beer.ratings || {};
      let sum = 0;
      for(const c of CRITERIA){
        const v = r[c.id];
        if(typeof v !== "number") return null;
        sum += v;
      }
      return sum; // 3..18
    }

    function beerComplete(beer){
      const r = beer.ratings || {};
      for(const c of CRITERIA){
        if(typeof r[c.id] !== "number") return false;
      }
      return true;
    }

    function globalAvg(){
      const totals = state.beers.map(b => beerTotal(b)).filter(v => typeof v === "number");
      if(!totals.length) return null;
      return totals.reduce((a,b)=>a+b,0) / totals.length;
    }

    function scoredBeerCount(){
      return state.beers.filter(b => beerTotal(b) !== null).length;
    }

    // ----------------------------
    // DOM helpers
    // ----------------------------
    const $ = (id) => document.getElementById(id);

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    let state = load();

    function applyTheme(){
      document.body.classList.toggle("light", state.theme === "light");
    }

    function renderStats(){
      $("statScored").textContent = `${scoredBeerCount()} / ${state.beers.length}`;
      const avg = globalAvg();
      $("statAvg").textContent = avg === null ? "-" : avg.toFixed(2);
      $("metaPill").textContent = `${state.settings.playerName} ‚Ä¢ ${state.beers.length} √∏l ‚Ä¢ ${CRITERIA.length} kriterier`;
    }

    function makeRankItem({rankIndex, beer, total}){
      const namePart = beer.name?.trim() ? ` ‚Ä¢ ${beer.name.trim()}` : "";
      const title = `√òl #${beer.num}${namePart}`;
      const sub = `Total: ${total} (3‚Äì18)`;
      return `
        <div class="rankItem">
          <div class="rankLeft">
            <div class="badge">${rankIndex}</div>
            <div class="rankText">
              <strong>${esc(title)}</strong>
              <span>${esc(sub)}</span>
            </div>
          </div>
          <div class="pill mono">${total}</div>
        </div>
      `;
    }

    function renderRankings(){
      const scored = state.beers
        .map(b => ({ beer: b, total: beerTotal(b) }))
        .filter(x => x.total !== null);

      const topEl = $("beerRankTop");
      const fysjEl = $("beerRankFysj");

      topEl.innerHTML = "";
      fysjEl.innerHTML = "";

      if(!scored.length){
        topEl.innerHTML = `<div class="muted">Ingen score enda.</div>`;
        fysjEl.innerHTML = `<div class="muted">Ingen score enda.</div>`;
        return;
      }

      // Top 3
      const top = [...scored].sort((a,b)=> b.total - a.total).slice(0, 3);
      top.forEach((x, i) => topEl.insertAdjacentHTML("beforeend", makeRankItem({ rankIndex: i+1, beer: x.beer, total: x.total })));

      // Fysj 3
      const fysj = [...scored].sort((a,b)=> a.total - b.total).slice(0, 3);
      fysj.forEach((x, i) => fysjEl.insertAdjacentHTML("beforeend", makeRankItem({ rankIndex: i+1, beer: x.beer, total: x.total })));
    }

    function buildCriteriaBlock(beer){
      const wrap = document.createElement("div");

      for(const c of CRITERIA){
        const crit = document.createElement("div");
        crit.className = "crit";

        const val = typeof beer.ratings?.[c.id] === "number" ? beer.ratings[c.id] : null;

        const top = document.createElement("div");
        top.className = "critTop";
        top.innerHTML = `<strong>${esc(c.label)}</strong><div class="val mono">${val===null ? "-" : val}</div>`;
        crit.appendChild(top);

        const dice = document.createElement("div");
        dice.className = "diceRow";
        for(let v=1; v<=6; v++){
          const b = document.createElement("button");
          b.className = "die" + (val===v ? " active" : "");
          b.textContent = v;
          b.onclick = () => setRating(beer.id, c.id, v);
          dice.appendChild(b);
        }
        crit.appendChild(dice);

        wrap.appendChild(crit);
      }

      return wrap;
    }

    function renderBeerList(){
      const list = $("beerList");
      list.innerHTML = "";

      const beers = [...state.beers].sort((a,b)=>a.num-b.num);

      for(const beer of beers){
        const total = beerTotal(beer);
        const isComplete = beerComplete(beer);

        const title = beer.name?.trim() ? beer.name.trim() : `Navn ikke satt`;
        const subtitle = `√òl #${beer.num} ‚Ä¢ ${isComplete ? "Ferdig ‚úÖ" : "Ikke ferdig"} ‚Ä¢ Total: ${total===null?"-":total}`;

        const el = document.createElement("div");
        el.className = "beer";
        el.dataset.beerId = beer.id;

        el.innerHTML = `
          <div class="beerHead">
            <div class="beerTitle">
              <div class="num">${beer.num}</div>
              <div class="name">
                <strong data-role="beerTitle">${esc(title)}</strong>
                <span data-role="beerSubtitle">${esc(subtitle)}</span>
              </div>
            </div>
            <div class="beerActions">
              <span class="pill mono" data-role="beerPill">${total===null ? "‚Äî" : total}</span>
              <button class="btn smallBtn" data-action="toggle" type="button">√Öpne</button>
            </div>
          </div>

          <div class="beerBody">
            <div class="scoreGrid">
              <div>
                <div class="field">
                  <label>Tipp √∏ltype/navn</label>
                  <input type="text" data-action="name" value="${esc(beer.name)}" placeholder="F.eks. Aass Jule√∏l" />
                  <div class="muted">Lagrer automatisk (etter et lite √∏yeblikk) mens du skriver.</div>
                </div>

                <div class="field">
                  <label>Notater (valgfritt)</label>
                  <input type="text" data-action="notes" value="${esc(beer.notes)}" placeholder="F.eks. karamell, krydder, litt bitter" />
                </div>

                <div class="criteria" data-criteria="1"></div>
              </div>

              <div>
                <div class="field">
                  <label>Oppsummering</label>
                  <div class="stat" style="margin-bottom:10px;">
                    <div class="k">Total (3‚Äì18)</div>
                    <div class="v" data-role="beerTotalBig">${total===null ? "-" : total}</div>
                  </div>
                  <div class="stat">
                    <div class="k">Status</div>
                    <div class="v" style="font-size:16px; font-weight:800;" data-role="beerStatus">
                      ${isComplete ? "Ferdig ‚úÖ" : "Mangler kast"}
                    </div>
                  </div>
                </div>

                <div class="field">
                  <label>Hurtig</label>
                  <div class="row">
                    <button class="btn danger smallBtn" data-action="clearBeer" type="button">T√∏m score for dette √∏let</button>
                    <button class="btn smallBtn" data-action="close" type="button">Lukk</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        `;

        const critWrap = el.querySelector('[data-criteria="1"]');
        critWrap.appendChild(buildCriteriaBlock(beer));

        list.appendChild(el);
      }
    }

    function render(){
      applyTheme();
      $("beerCount").value = state.settings.beerCount;
      $("playerNameInput").value = state.settings.playerName;
      renderStats();
      renderRankings();
      renderBeerList();
    }

    // ----------------------------
    // Actions
    // ----------------------------
    function openBeerById(beerId){
      const el = document.querySelector(`[data-beer-id="${beerId}"]`);
      if(!el) return;
      el.classList.add("open");
      el.scrollIntoView({ block: "nearest", behavior: "smooth" });
    }

    function closeBeerById(beerId){
      const el = document.querySelector(`[data-beer-id="${beerId}"]`);
      if(!el) return;
      el.classList.remove("open");
    }

    function setRating(beerId, critId, value){
      const beer = state.beers.find(b => b.id === beerId);
      if(!beer) return;
      if(!beer.ratings) beer.ratings = {};
      beer.ratings[critId] = value;

      save();
      render();
      setTimeout(() => openBeerById(beerId), 0);
    }

    function rebuildFromInputs(){
      const count = clampInt($("beerCount").value, 1, 60);
      state.settings.beerCount = count;
      state = ensureBeerCount(state, count);
      save();
      render();
    }

    function clearBeer(beerId){
      if(!confirm("T√∏mme score for dette √∏let?")) return;
      const beer = state.beers.find(b => b.id === beerId);
      if(!beer) return;
      beer.ratings = {};
      save();
      render();
      openBeerById(beerId);
    }

    function resetAll(){
      if(!confirm("Nullstille ALT? (√∏l, navn, score)")) return;
      state = defaultState();
      save();
      render();
    }

    // Update header UI without full render (prevents jumping while typing)
    function updateBeerHeaderUI(beerId){
      const beer = state.beers.find(b => b.id === beerId);
      const el = document.querySelector(`[data-beer-id="${beerId}"]`);
      if(!beer || !el) return;

      const total = beerTotal(beer);
      const isComplete = beerComplete(beer);
      const title = beer.name?.trim() ? beer.name.trim() : `Navn ikke satt`;
      const subtitle = `√òl #${beer.num} ‚Ä¢ ${isComplete ? "Ferdig ‚úÖ" : "Ikke ferdig"} ‚Ä¢ Total: ${total===null?"-":total}`;

      const titleEl = el.querySelector('[data-role="beerTitle"]');
      const subEl = el.querySelector('[data-role="beerSubtitle"]');
      const pillEl = el.querySelector('[data-role="beerPill"]');
      const bigEl = el.querySelector('[data-role="beerTotalBig"]');
      const statusEl = el.querySelector('[data-role="beerStatus"]');

      if(titleEl) titleEl.textContent = title;
      if(subEl) subEl.textContent = subtitle;
      if(pillEl) pillEl.textContent = (total===null ? "‚Äî" : String(total));
      if(bigEl) bigEl.textContent = (total===null ? "-" : String(total));
      if(statusEl) statusEl.textContent = (isComplete ? "Ferdig ‚úÖ" : "Mangler kast");
    }

    // ----------------------------
    // Event listeners
    // ----------------------------
    $("themeBtn").addEventListener("click", () => {
      state.theme = (state.theme === "light") ? "dark" : "light";
      save();
      render();
    });

    $("resetBtn").addEventListener("click", resetAll);

    $("rebuildBtn").addEventListener("click", rebuildFromInputs);
    $("beerCount").addEventListener("change", rebuildFromInputs);

    $("playerNameInput").addEventListener("input", (e) => {
      state.settings.playerName = String(e.target.value ?? "").trim() || "Deg";
      saveDebounced();
      renderStats();
    });

    // Setup tabs (Oppsett / Historikk)
    document.querySelectorAll(".setupTab").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;

        document.querySelectorAll(".setupTab").forEach(b => b.classList.toggle("active", b === btn));
        document.querySelectorAll(".setupPane").forEach(p => p.classList.toggle("active", p.dataset.pane === tab));
      });
    });

    // Delegated events for beer list
    document.addEventListener("click", (e) => {
      const beerEl = e.target.closest(".beer");
      if(!beerEl) return;
      const beerId = beerEl.dataset.beerId;
      const action = e.target?.dataset?.action;

      if(action === "toggle"){ beerEl.classList.toggle("open"); return; }
      if(action === "close"){ closeBeerById(beerId); return; }
      if(action === "clearBeer"){ clearBeer(beerId); return; }
    });

    // Input events inside beer cards (NO full render while typing)
    document.addEventListener("input", (e) => {
      const beerEl = e.target.closest(".beer");
      if(!beerEl) return;
      const beerId = beerEl.dataset.beerId;
      const beer = state.beers.find(b => b.id === beerId);
      if(!beer) return;

      const action = e.target?.dataset?.action;
      if(action === "name"){
        beer.name = e.target.value;
        saveDebounced();
        updateBeerHeaderUI(beerId);
        renderRankings();
      }
      if(action === "notes"){
        beer.notes = e.target.value;
        saveDebounced();
      }
    });

    // ----------------------------
    // Init
    // ----------------------------
    applyTheme();
    render();
  </script>
</body>
</html>
